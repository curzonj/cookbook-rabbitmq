%%%
%% Generated by Chef
%%%

[
  {rabbit, [
<% if node['rabbitmq']['cluster'] && node['rabbitmq']['cluster_disk_nodes'] -%>
    {cluster_nodes, [<%= node['rabbitmq']['cluster_disk_nodes'].map{|n| "\'#{n}\'"}.join(',') %>]},
<% end %>
<% if node['rabbitmq']['ssl'] -%>
    {ssl_listeners, [<%= node['rabbitmq']['ssl_port'] %>]},
    {ssl_options, [{cacertfile,"<%= node['rabbitmq']['ssl_cacert'] %>"},
                    {certfile,"<%= node['rabbitmq']['ssl_cert'] %>"},
                    {keyfile,"<%= node['rabbitmq']['ssl_key'] %>"},
                    {verify,verify_none},
                    {fail_if_no_peer_cert,false}]},
<% end %>
<% if node['rabbitmq']['disk_free_limit_relative'] -%>
    {disk_free_limit, {mem_relative, <%= node['rabbitmq']['disk_free_limit_relative'] %>}},
<% end %>
<% if node['rabbitmq']['vm_memory_high_watermark'] -%>
    {vm_memory_high_watermark, <%= node['rabbitmq']['vm_memory_high_watermark'] %>},
<% end %>
    {default_user, <<"<%= node['rabbitmq']['default_user'] %>">>},
    {default_pass, <<"<%= node['rabbitmq']['default_pass'] %>">>}
    ]},

%% Read this for details http://www.rabbitmq.com/shovel.html
  {rabbitmq_shovel,
    [ {shovels, [ {my_first_shovel,
                    [ {sources,
                        [ {broker, "amqp://fred:secret@localhost/my_vhost" }
                        , {declarations, [ {'exchange.declare',
                                              [ {exchange, <<"my_fanout">>}
                                              , {type, <<"fanout">>}
                                              , durable
                                              ]}
                                         , {'queue.declare',
                                              [{arguments,
                                                 [{<<"x-message-ttl">>, long, 60000}]}]}
                                         , {'queue.bind',
                                              [ {exchange, <<"my_fanout">>}
                                              , {queue,    <<>>}
                                              ]}
                                         ]}
                        ]}
                    , {destinations,
                        [ {broker, "amqp://fred:secret@localhost/my_vhost"}
                        , {declarations, [ {'exchange.declare',
                                              [ {exchange, <<"my_direct">>}
                                              , {type, <<"direct">>}
                                              , durable
                                              ]}
                                         ]}
                        ]}
                    , {queue, <<>>}
                    , {prefetch_count, 10}
                    , {ack_mode, on_confirm}
                    , {publish_properties, [ {delivery_mode, 2} ]}
                    , {publish_fields, [ {exchange, <<"my_direct">>}
                                       , {routing_key, <<"from_shovel">>}
                                       ]}
                    , {reconnect_delay, 5}
                    ]}
                ]}
    ]}

].
